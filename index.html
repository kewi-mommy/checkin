<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è‘µç²‰å‹•èµ·ä¾†</title>
    
    <!-- é è¦½è¨­å®šï¼šå·²æ›´æ–° -->
    <meta property="og:title" content="è‘µç²‰å‹•èµ·ä¾†">
    <meta property="og:description" content="VIPé›†é»æ›å¥½ç¦®">
    <meta property="og:type" content="website">
    <meta property="og:image" content="https://i.postimg.cc/WbcnW6XV/002-kui-fen-dong-qi-lai-vivipic-(3).jpg">

    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://unpkg.com/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        :root { --line-green: #06C755; --kewi-pink: #FF85A2; --bg-gray: #F4F6F9; }
        body, html { margin: 0; padding: 0; background: var(--bg-gray); font-family: -apple-system, sans-serif; }
        
        #loading-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #ffffff; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; }
        .svg-heart { width: 70px; height: 70px; fill: var(--kewi-pink); animation: pulse 1.2s infinite; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
        .loader-text { margin-top: 25px; font-size: 16px; color: #555; font-weight: bold; }
        .progress-container { width: 200px; height: 8px; background: #eee; border-radius: 10px; margin-top: 15px; overflow: hidden; }
        .progress-bar { width: 0%; height: 100%; background: var(--kewi-pink); transition: width 0.4s ease; }

        #main-app { display: none; height: 100vh; overflow-y: auto; -webkit-overflow-scrolling: touch; }
        .header { background: linear-gradient(135deg, var(--line-green), #05a346); padding: 35px 20px; text-align: center; color: white; border-bottom-left-radius: 30px; border-bottom-right-radius: 30px; }
        .avatar { width: 75px; height: 75px; border-radius: 50%; border: 2px solid #fff; object-fit: cover; margin-bottom: 8px; background: #eee; }
        .points-val { font-size: 48px; font-weight: 800; margin: 5px 0; }
        
        .container { max-width: 450px; margin: -25px auto 40px; padding: 0 15px; }
        .card { background: white; border-radius: 20px; padding: 20px; box-shadow: 0 8px 20px rgba(0,0,0,0.05); margin-bottom: 15px; text-align: center; }
        .status-box { font-size: 13px; color: #666; margin-bottom: 12px; padding: 12px; background: #e8f5e9; border-radius: 12px; font-weight: bold; }
        .btn-main { background: #333; color: white; border: none; padding: 16px; width: 100%; border-radius: 12px; font-size: 17px; font-weight: bold; cursor: pointer; }
        .btn-submit { background: var(--line-green); margin-top: 10px; display: none; box-shadow: 0 4px 15px rgba(6,199,85,0.3); }
        
        .rewards-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
        .reward-card { background: #fff; border: 1px solid #eee; border-radius: 15px; padding: 10px; }
        .reward-name { font-size: 11px; height: 32px; overflow: hidden; font-weight: bold; margin-bottom: 6px; display: flex; align-items: center; justify-content: center; line-height: 1.2; }
        .reward-img { width: 100%; aspect-ratio: 1 / 1; border-radius: 10px; object-fit: cover; background: #f9f9f9; margin-bottom: 8px; }
        .progress-info { display: flex; justify-content: space-between; font-size: 10px; margin-bottom: 4px; font-weight: bold; color: #333; }
        .progress-bg { background: #eee; height: 7px; border-radius: 4px; overflow: hidden; }
        .progress-fill { background: var(--line-green); height: 100%; width: 0%; transition: width 0.6s; }
        #preview { width: 100%; border-radius: 15px; margin-top: 15px; display: none; }
    </style>
</head>
<body>

<div id="loading-screen">
    <svg class="svg-heart" viewBox="0 0 32 32"><path d="M16 28.5L14.1 26.8C7.33 20.62 3 16.66 3 11.85C3 7.84 6.09 4.75 10 4.75C12.21 4.75 14.33 5.79 15.7 7.44C15.81 7.57 15.91 7.71 16 7.85C16.09 7.71 16.19 7.57 16.3 7.44C17.67 5.79 19.79 4.75 22 4.75C25.91 4.75 29 7.84 29 11.85C29 16.66 24.67 20.62 17.9 26.82L16 28.5Z"/></svg>
    <div class="loader-text" id="ld-status">æ­£åœ¨å•Ÿå‹•ç³»çµ±...</div>
    <div class="progress-container"><div id="ld-bar" class="progress-bar"></div></div>
</div>

<div id="main-app">
    <div class="header"><img id="user-avatar" class="avatar" src=""><div id="user-name">è¼‰å…¥ä¸­...</div><div class="points-val" id="points-display">--</div></div>
    <div class="container">
        <div class="card">
            <div id="status" class="status-box">è«‹ä¸Šå‚³æ‚¨çš„å°è©±æˆªåœ–</div>
            <input type="file" id="file-input" accept="image/*" style="display:none">
            <button id="upload-btn" class="btn-main" onclick="document.getElementById('file-input').click()">ğŸ“¸ é¸å–ç…§ç‰‡</button>
            <img id="preview">
            <button id="submit-btn" class="btn-main btn-submit" onclick="handleSubmit()">ğŸš€ ç¢ºèªé€å‡ºæ‰“å¡</button>
        </div>
        <div class="card" style="text-align:left;"><div style="font-weight:bold; margin-bottom:12px;">ğŸ VIPé›†é»æ›å¥½ç¦®</div><div id="rewards-grid" class="rewards-grid">è¼‰å…¥çå“ä¸­...</div></div>
    </div>
</div>

<script>
    const LIFF_ID = "2008852092-FWAMmdWd";
    const GAS_URL = "https://script.google.com/macros/s/AKfycbydAUJv9hkMsWFuFNTMoSQ61Md67yE-LyjTh4bg8U97NPgyG2ZvkdY_flflAcBxd4ol/exec";
    
    let userId="", userName="", worker=null, currentPoints=0;
    function setLd(p, txt) { document.getElementById("ld-bar").style.width = p + "%"; if(txt) document.getElementById("ld-status").innerText = txt; }
    
    window.onload = async function() {
        setLd(10, "é€£ç·š LINE...");
        try {
            await liff.init({ liffId: LIFF_ID });
            if (!liff.isLoggedIn()) { liff.login(); return; }
            const profile = await liff.getProfile();
            userId = profile.userId; userName = profile.displayName;
            document.getElementById("user-name").innerText = userName;
            document.getElementById("user-avatar").src = profile.pictureUrl || "";
            fetchData();
            setLd(50, "å•Ÿå‹• AI å¼•æ“...");
            worker = await Tesseract.createWorker({ 
                logger: m => { if(m.status === 'loading chi_tra') setLd(50 + (m.progress * 45), `ä¸‹è¼‰è³‡æº: ${Math.round(m.progress*100)}%`); } 
            });
            await worker.loadLanguage('chi_tra');
            await worker.initialize('chi_tra');
            setLd(100, "æº–å‚™å°±ç·’ï¼");
            setTimeout(() => { document.getElementById("loading-screen").style.display = "none"; document.getElementById("main-app").style.display = "block"; }, 400);
        } catch (err) { document.getElementById("loading-screen").style.display = "none"; document.getElementById("main-app").style.display = "block"; }
    };

    async function fetchData() {
        try {
            const res = await fetch(`${GAS_URL}?userId=${userId}`);
            const data = await res.json();
            currentPoints = data.points;
            document.getElementById("points-display").innerText = currentPoints;
            const grid = document.getElementById("rewards-grid");
            grid.innerHTML = "";
            data.rewards.forEach(r => {
                let p = Math.min((currentPoints / r.required) * 100, 100);
                grid.innerHTML += `<div class="reward-card"><div class="reward-name">${r.name}</div><div class="reward-img-container"><img src="${r.image || 'https://via.placeholder.com/150'}" class="reward-img"></div><div class="progress-info"><span>${currentPoints}é»</span><span>ç›®æ¨™${r.required}</span></div><div class="progress-bg"><div class="progress-fill" style="width:${p}%"></div></div></div>`;
            });
        } catch (e) { }
    }

    document.getElementById('file-input').onchange = (e) => {
        if (!e.target.files[0]) return;
        const reader = new FileReader();
        reader.onload = (ev) => {
            document.getElementById('preview').src = ev.target.result;
            document.getElementById('preview').style.display = 'block';
            document.getElementById('submit-btn').style.display = 'block';
        };
        reader.readAsDataURL(e.target.files[0]);
    };

    // --- ã€é€²éšå„ªåŒ–ã€‘ä¸é™é«˜åº¦ + è‰²å½©éæ¿¾å¢å¼· ---
    function processImage(img, scale, filterMode) {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        
        // ä¿ç•™ 100% é«˜åº¦ï¼Œåªåˆ‡é™¤å·¦å´ 25% é ­åƒå€
        const startX = img.width * 0.25;
        const cropWidth = img.width * 0.75;
        canvas.width = cropWidth * scale;
        canvas.height = img.height * scale;
        
        ctx.imageSmoothingEnabled = false;
        ctx.drawImage(img, startX, 0, cropWidth, img.height, 0, 0, canvas.width, canvas.height);
        
        let id = ctx.getImageData(0, 0, canvas.width, canvas.height);
        let data = id.data;

        for (let i = 0; i < data.length; i += 4) {
            let r = data[i], g = data[i+1], b = data[i+2];
            let v;
            
            // å¿ƒç†å­¸äº®åº¦å…¬å¼
            let brightness = 0.299*r + 0.587*g + 0.114*b;

            if (filterMode === "aggressive") {
                // å¼·åŠ›éæ¿¾æ¨¡å¼ï¼šä»»ä½•æœ‰è‰²å½©çš„ï¼ˆæ³¡æ³¡è‰²ï¼‰æˆ–æ·ºè‰²çš„ï¼ˆèƒŒæ™¯è‰²ï¼‰é€šé€šè½‰ç™½
                // åˆ¤æ–·æ˜¯å¦ç‚ºã€Œéä¸­æ€§è‰²ã€ï¼ˆå³å½©è‰²ï¼‰
                let isColor = Math.max(r,g,b) - Math.min(r,g,b) > 20;
                if (isColor || brightness > 140) {
                    v = 255;
                } else {
                    v = 0; // åªæœ‰æ·±é»‘è‰²çš„å­—æœƒç•™ä¸‹
                }
            } else {
                // æ¨™æº–å°æ¯”æ¨¡å¼
                v = brightness < 155 ? 0 : 255;
            }
            data[i] = data[i+1] = data[i+2] = v;
        }
        ctx.putImageData(id, 0, 0);
        return canvas.toDataURL();
    }

    async function handleSubmit() {
        const btn = document.getElementById("submit-btn");
        btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> è¾¨è­˜ä¸­...';
        document.getElementById("status").innerText = "ğŸ” æ­£åœ¨å…¨å±æ·±åº¦æ ¡å°æ–‡å­—...";
        
        const img = new Image(); img.src = document.getElementById('preview').src;
        await img.decode();
        
        try {
            // é›™é‡æƒæï¼š1.5x (å¤§å­—é«”) + 3.2x (å¼·åŠ›éæ¿¾èƒŒæ™¯)
            const d1 = processImage(img, 1.5, "standard");
            const r1 = await worker.recognize(d1);
            
            const d2 = processImage(img, 3.2, "aggressive");
            const r2 = await worker.recognize(d2);

            const combined = (r1.data.text + " " + r2.data.text).replace(/\s+/g, "");

            const res = await fetch(GAS_URL, {
                method: "POST",
                body: JSON.stringify({ userId, userName, rawText: combined, date: new Date().toLocaleDateString('en-CA') })
            });

            alert(await res.text());
            document.getElementById('preview').style.display = 'none';
            btn.style.display = 'none'; btn.disabled = false; btn.innerHTML = "ğŸš€ ç¢ºèªé€å‡ºæ‰“å¡";
            fetchData();
        } catch (err) { alert("è¾¨è­˜è¶…æ™‚ï¼Œè«‹ç¢ºä¿æˆªåœ–æ¸…æ™°"); btn.disabled = false; }
    }
</script>
</body>
</html>

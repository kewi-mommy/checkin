<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœƒå“¡é›†é»ç³»çµ±</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://unpkg.com/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
    <style>
        body { font-family: sans-serif; text-align: center; padding: 20px; background: #f4f4f4; margin: 0; }
        .card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); max-width: 400px; margin: auto; }
        #preview { width: 100%; border-radius: 10px; margin-top: 15px; display: none; border: 1px solid #ddd; }
        button { background: #00b900; color: white; border: none; padding: 15px 20px; border-radius: 10px; cursor: pointer; font-size: 16px; margin-top: 10px; width: 100%; font-weight: bold; }
        button:disabled { background: #ccc; }
        #status { margin-top: 15px; color: #333; font-size: 14px; line-height: 1.6; }
        .debug-text { color: #888; font-size: 12px; background: #eee; padding: 5px; margin-top: 10px; border-radius: 5px; word-break: break-all; }
    </style>
</head>
<body>

<div class="card">
    <h2 id="user-name">æ­£åœ¨è¼‰å…¥...</h2>
    <div id="status">è«‹é¸å– LINE å°è©±æˆªåœ–</div>
    
    <input type="file" id="file-input" accept="image/*" style="display:none">
    <button onclick="document.getElementById('file-input').click()">ğŸ“¸ é¸å–æˆªåœ–</button>
    
    <img id="preview">
    <button id="submit-btn" style="display:none">ğŸš€ ç¢ºèªé€å‡ºæ‰“å¡</button>
    <div id="debug-info" class="debug-text" style="display:none"></div>
</div>

<script>
// --- è«‹å‹™å¿…å¡«å¯«ä½ çš„è³‡è¨Š ---
const LIFF_ID = "2008852092-FWAMmdWd"; 
const GAS_URL = "https://script.google.com/macros/s/AKfycbydAUJv9hkMsWFuFNTMoSQ61Md67yE-LyjTh4bg8U97NPgyG2ZvkdY_flflAcBxd4ol/exec";
// -----------------------

let userId = "", userName = "";

async function init() {
    await liff.init({ liffId: LIFF_ID });
    if (!liff.isLoggedIn()) {
        liff.login();
    } else {
        const profile = await liff.getProfile();
        userId = profile.userId;
        userName = profile.displayName;
        document.getElementById("user-name").innerText = `ä½ å¥½ï¼Œ${userName}`;
    }
}

document.getElementById('file-input').onchange = function(e) {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(event) {
        const img = document.getElementById('preview');
        img.src = event.target.result;
        img.style.display = 'block';
        document.getElementById('submit-btn').style.display = 'block';
        document.getElementById('status').innerText = "åœ–ç‰‡å·²å°±ç·’ï¼Œè«‹é»æ“Šé€å‡º";
    };
    reader.readAsDataURL(file);
};

document.getElementById('submit-btn').onclick = async function() {
    const status = document.getElementById('status');
    const debugInfo = document.getElementById('debug-info');
    const btn = this;
    
    btn.disabled = true;
    status.innerHTML = "ğŸ” æ­£åœ¨åˆ†æåœ–ç‰‡...<br>(å­—é«”è¼ƒå°æ™‚å¯èƒ½éœ€ 10-15 ç§’)";

    const img = new Image();
    img.src = document.getElementById('preview').src;
    await img.decode();

    // --- åœ–ç‰‡è™•ç†å¢å¼·ï¼šæ”¾å¤§ 3 å€ + è£åˆ‡å³åŠéƒ¨ ---
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    const scale = 3; // æ”¾å¤§ 3 å€æé«˜è¾¨è­˜ç‡
    const cropWidth = img.width * 0.5;
    
    canvas.width = cropWidth * scale;
    canvas.height = img.height * scale;
    
    // å¹³æ»‘åŒ–è¨­å®š (è®“æ”¾å¤§å¾Œçš„å­—ä¸æ¨¡ç³Š)
    ctx.imageSmoothingEnabled = false;
    
    ctx.drawImage(img, 
        img.width * 0.5, 0, cropWidth, img.height, // ä¾†æºï¼šåŸåœ–å³åŠéƒ¨
        0, 0, canvas.width, canvas.height         // ç›®æ¨™ï¼šæ”¾å¤§å¾Œç•«å¸ƒ
    );

    // è½‰é»‘ç™½å°æ¯”å¼·åŒ–
    let imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    let pixels = imgData.data;
    for (let i = 0; i < pixels.length; i += 4) {
        let avg = (pixels[i] + pixels[i+1] + pixels[i+2]) / 3;
        let grayscale = avg < 170 ? 0 : 255; // æé«˜å°æ¯”é–€æª»
        pixels[i] = pixels[i+1] = pixels[i+2] = grayscale;
    }
    ctx.putImageData(imgData, 0, 0);

    try {
        // ä½¿ç”¨ç¹é«”ä¸­æ–‡è¾¨è­˜
        const { data: { text } } = await Tesseract.recognize(canvas.toDataURL(), 'chi_tra');
        const cleanText = text.replace(/\s+/g, ""); // å»é™¤æ‰€æœ‰ç©ºæ ¼
        
        debugInfo.innerText = "æ©Ÿå™¨çœ‹åˆ°çš„æ–‡å­—ï¼š" + cleanText;
        debugInfo.style.display = "block";

        status.innerText = "ğŸš€ æ­£åœ¨åŒæ­¥è‡³è©¦ç®—è¡¨...";

        const response = await fetch(GAS_URL, {
            method: "POST",
            body: JSON.stringify({
                userId: userId,
                userName: userName,
                rawText: cleanText,
                date: new Date().toLocaleDateString('en-CA')
            })
        });

        const result = await response.text();
        alert(result);
        status.innerText = result;
        
        if(result.includes("æˆåŠŸ")) {
            document.getElementById('preview').style.display = 'none';
            btn.style.display = 'none';
        }
    } catch (err) {
        alert("è¾¨è­˜éç¨‹ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹é‡æ–°å˜—è©¦");
        status.innerText = "éŒ¯èª¤: " + err;
    } finally {
        btn.disabled = false;
    }
};

init();
</script>
</body>
</html>
